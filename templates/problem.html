{% extends "base.html" %}

{% block title %}{{ problem.title }} - CodeXam{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-6">
        <!-- Problem Description -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">{{ problem.title }}</h4>
                <span class="badge 
                    {% if problem.difficulty == 'Easy' %}bg-success
                    {% elif problem.difficulty == 'Medium' %}bg-warning
                    {% else %}bg-danger{% endif %} fs-6">
                    {{ problem.difficulty }}
                </span>
            </div>
            <div class="card-body">
                <div class="problem-description">
                    {{ problem.description|nl2br }}
                </div>
                
                {% if problem.sample_input and problem.sample_output %}
                <div class="mt-4">
                    <h6>Example:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Input:</strong>
                            <pre class="bg-light p-2 rounded"><code>{{ problem.sample_input }}</code></pre>
                        </div>
                        <div class="col-md-6">
                            <strong>Output:</strong>
                            <pre class="bg-light p-2 rounded"><code>{{ problem.sample_output }}</code></pre>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Previous Submissions -->
        {% if user_submissions %}
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Your Previous Submissions</h6>
            </div>
            <div class="card-body">
                {% for submission in user_submissions[:3] %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="badge 
                            {% if submission.result == 'PASS' %}bg-success
                            {% elif submission.result == 'FAIL' %}bg-warning
                            {% else %}bg-danger
                            {% endif %}">
                            {{ submission.result }}
                        </span>
                        <small class="text-muted ms-2">{{ submission.language }}</small>
                    </div>
                    <small class="text-muted">{{ submission.submitted_at }}</small>
                </div>
                {% endfor %}
                {% if user_submissions|length > 3 %}
                <a href="{{ url_for('submissions_history') }}" class="btn btn-sm btn-outline-primary">
                    View all submissions
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-6">
        <!-- Code Editor -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Code Editor</h6>
                    <select id="language-select" class="form-select form-select-sm" style="width: auto;">
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="java">Java</option>
                        <option value="cpp">C++</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <textarea id="code-editor" class="form-control border-0" rows="15" placeholder="Write your code here..."></textarea>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <button id="reset-code" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button id="submit-code" class="btn btn-primary">
                        <i class="fas fa-play"></i> Run Solution
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="result-container" class="mt-3" style="display: none;">
            <!-- Results will be displayed here -->
        </div>
    </div>
</div>

<!-- Hidden form data -->
<input type="hidden" id="problem-id" value="{{ problem.id }}">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
#code-editor {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    resize: vertical;
    min-height: 300px;
}

.problem-description {
    white-space: pre-wrap;
    line-height: 1.6;
}

.result-success {
    border-left: 4px solid #28a745;
    background-color: #d4edda;
}

.result-error {
    border-left: 4px solid #dc3545;
    background-color: #f8d7da;
}

.result-fail {
    border-left: 4px solid #ffc107;
    background-color: #fff3cd;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Function signatures for different languages
const functionTemplates = {
    python: 'def solution(nums, target):\n    pass',
    javascript: 'function solution(nums, target) {\n    // Your code here\n}',
    java: 'public int[] solution(int[] nums, int target) {\n    // Your code here\n}',
    cpp: 'vector<int> solution(vector<int>& nums, int target) {\n    // Your code here\n}'
};

// Initialize code editor
document.addEventListener('DOMContentLoaded', function() {
    const languageSelect = document.getElementById('language-select');
    const codeEditor = document.getElementById('code-editor');
    const resetButton = document.getElementById('reset-code');
    const submitButton = document.getElementById('submit-code');
    const resultContainer = document.getElementById('result-container');
    
    // Set initial template
    updateCodeTemplate();
    
    // Language change handler
    languageSelect.addEventListener('change', function() {
        updateCodeTemplate();
    });
    
    // Reset button handler
    resetButton.addEventListener('click', function() {
        updateCodeTemplate();
    });
    
    // Submit button handler
    submitButton.addEventListener('click', function() {
        submitCode();
    });
    
    function updateCodeTemplate() {
        const language = languageSelect.value;
        const template = functionTemplates[language] || '';
        codeEditor.value = template;
    }
    
    function submitCode() {
        const code = codeEditor.value.trim();
        const language = languageSelect.value;
        const problemId = document.getElementById('problem-id').value;
        
        if (!code) {
            alert('Please write some code before submitting.');
            return;
        }
        
        // Disable submit button
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
        
        // Prepare form data
        const formData = new FormData();
        formData.append('problem_id', problemId);
        formData.append('code', code);
        formData.append('language', language);
        
        fetch('/submit', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showResult(data.result.toLowerCase(), data.message, data.execution_time);
        })
        .catch(error => {
            showResult('error', 'Submission failed. Please try again.', null);
            console.error('Submission error:', error);
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-play"></i> Run Solution';
        });
    }
    
    function showResult(result, message, executionTime) {
        let icon, bgClass, textClass;
        
        switch (result) {
            case 'pass':
                icon = 'fas fa-check-circle';
                bgClass = 'result-success';
                textClass = 'text-success';
                break;
            case 'fail':
                icon = 'fas fa-times-circle';
                bgClass = 'result-fail';
                textClass = 'text-warning';
                break;
            default:
                icon = 'fas fa-exclamation-circle';
                bgClass = 'result-error';
                textClass = 'text-danger';
        }
        
        let timeInfo = '';
        if (executionTime !== null) {
            timeInfo = `<small class="text-muted">Execution time: ${executionTime.toFixed(3)}s</small>`;
        }
        
        resultContainer.innerHTML = `
            <div class="alert ${bgClass}">
                <div class="d-flex align-items-center">
                    <i class="${icon} ${textClass} me-2"></i>
                    <div>
                        <strong class="${textClass}">${result.toUpperCase()}</strong>
                        <p class="mb-0">${message}</p>
                        ${timeInfo}
                    </div>
                </div>
            </div>
        `;
        
        resultContainer.style.display = 'block';
        resultContainer.scrollIntoView({ behavior: 'smooth' });
    }
});
</script>
{% endblock %}