{% extends "base.html" %}

{% block title %}{{ problem.title }} - Elite Challenge - CodeXam{% endblock %}

{% block body_class %}problem-detail-page{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav class="breadcrumb-nav" aria-label="Breadcrumb">
    <div class="container">
        <ol class="breadcrumb-list">
            <li class="breadcrumb-item">
                <a href="{{ url_for('index') }}" class="breadcrumb-link">
                    <span class="breadcrumb-icon">üè†</span>
                    <span>Home</span>
                </a>
            </li>
            <li class="breadcrumb-separator">/</li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('problems_list') }}" class="breadcrumb-link">
                    <span class="breadcrumb-icon">‚ö°</span>
                    <span>Problems</span>
                </a>
            </li>
            <li class="breadcrumb-separator">/</li>
            <li class="breadcrumb-item active" aria-current="page">
                <span class="breadcrumb-text">{{ problem.title }}</span>
            </li>
        </ol>
    </div>
</nav>

<!-- Problem Header -->
<section class="problem-header">
    <div class="container">
        <div class="problem-meta">
            <div class="problem-title-section">
                <h1 class="problem-title">{{ problem.title }}</h1>
                <div class="problem-badges">
                    <span class="difficulty-badge difficulty-{{ problem.difficulty.lower() }}">
                        {{ problem.difficulty }}
                    </span>
                    <span class="problem-id-badge">
                        #{{ problem.id }}
                    </span>
                </div>
            </div>

            <div class="problem-stats">
                <div class="stat-item">
                    <span class="stat-icon">üë•</span>
                    <span class="stat-value">{{ (problem.id * 47) % 1000 }}</span>
                    <span class="stat-label">solved</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">‚ö°</span>
                    <span class="stat-value">{{ (problem.id * 23) % 60 + 15 }}min</span>
                    <span class="stat-label">avg time</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">üéØ</span>
                    <span class="stat-value">{{ (problem.id * 13) % 40 + 60 }}%</span>
                    <span class="stat-label">success</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Split Pane Layout -->
<section class="problem-workspace">
    <div class="container-fluid">
        <div class="split-pane-container">
            <!-- Left Pane: Problem Description -->
            <div class="problem-pane">
                <div class="pane-content">
                    <!-- Problem Description -->
                    <div class="problem-section">
                        <h2 class="section-title">
                            <span class="section-icon">üìã</span>
                            Challenge Description
                        </h2>
                        <div class="problem-description">
                            {{ problem.description|nl2br }}
                        </div>
                    </div>

                    <!-- Examples Section -->
                    {% if problem.sample_input and problem.sample_output %}
                    <div class="problem-section">
                        <h3 class="section-title">
                            <span class="section-icon">üí°</span>
                            Example
                        </h3>
                        <div class="example-container">
                            <div class="example-item">
                                <h4 class="example-label">Input:</h4>
                                <pre class="code-block"><code>{{ problem.sample_input }}</code></pre>
                            </div>
                            <div class="example-item">
                                <h4 class="example-label">Output:</h4>
                                <pre class="code-block"><code>{{ problem.sample_output }}</code></pre>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Function Signatures -->
                    <div class="problem-section">
                        <h3 class="section-title">
                            <span class="section-icon">üîß</span>
                            Function Signatures
                        </h3>
                        <div class="signatures-container">
                            {% for language, signature in problem.function_signatures.items() %}
                            <div class="signature-item">
                                <div class="signature-header">
                                    <span class="language-tag">{{ language }}</span>
                                </div>
                                <pre class="code-block"><code>{{ signature }}</code></pre>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Previous Submissions -->
                    {% if user_submissions %}
                    <div class="problem-section">
                        <h3 class="section-title">
                            <span class="section-icon">üìä</span>
                            Your Recent Attempts
                        </h3>
                        <div class="submissions-preview">
                            {% for submission in user_submissions[:3] %}
                            <div class="submission-item">
                                <div class="submission-status">
                                    <span class="status-badge status-{{ submission.result.lower() }}">
                                        {{ submission.result }}
                                    </span>
                                    <span class="submission-language">{{ submission.language }}</span>
                                </div>
                                <div class="submission-meta">
                                    <span class="submission-time">{{ submission.submitted_at }}</span>
                                    {% if submission.execution_time %}
                                    <span class="execution-time">{{ "%.3f"|format(submission.execution_time) }}s</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                            {% if user_submissions|length > 3 %}
                            <div class="submissions-link">
                                <a href="{{ url_for('submissions_history') }}" class="btn-cyber-secondary btn-sm">
                                    View All Submissions ‚Üí
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Resize Handle -->
            <div class="resize-handle" id="resizeHandle">
                <div class="resize-indicator"></div>
            </div>

            <!-- Right Pane: Code Editor -->
            <div class="editor-pane">
                <div class="pane-content">
                    <!-- Editor Header -->
                    <div class="editor-header">
                        <div class="editor-title">
                            <span class="editor-icon">‚ö°</span>
                            <span>Code Editor</span>
                        </div>
                        <div class="editor-controls">
                            <select id="language-select" class="language-selector">
                                <option value="python">Python</option>
                                <option value="javascript">JavaScript</option>
                                <option value="java">Java</option>
                                <option value="cpp">C++</option>
                            </select>
                        </div>
                    </div>

                    <!-- Code Editor -->
                    <div class="editor-container">
                        <div class="editor-wrapper">
                            <!-- Line Numbers -->
                            <div class="line-numbers" id="lineNumbers">
                                <div class="line-number">1</div>
                            </div>

                            <!-- Code Editor with Syntax Highlighting -->
                            <div class="code-editor-container">
                                <pre class="syntax-highlight" id="syntaxHighlight"><code></code></pre>
                                <textarea id="code-editor" class="code-editor"
                                    placeholder="// Initialize your solution here..." spellcheck="false"
                                    autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Editor Footer -->
                    <div class="editor-footer">
                        <div class="editor-actions">
                            <button id="reset-code" class="btn-cyber-secondary btn-sm">
                                <span class="btn-icon">‚Üª</span>
                                <span>Reset</span>
                            </button>
                            <button id="submit-code" class="btn-cyber-primary">
                                <span class="btn-icon">‚ñ∂</span>
                                <span>Execute_Code()</span>
                            </button>
                        </div>
                    </div>

                    <!-- Results Container -->
                    <div id="result-container" class="result-container" style="display: none;">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Hidden form data -->
<input type="hidden" id="problem-id" value="{{ problem.id }}">
{% endblock %}

{% block extra_css %}
<style>
    /* Problem Detail Page Layout */
    .problem-detail-page {
        background: var(--bg-primary);
        min-height: 100vh;
    }

    /* Breadcrumb Navigation */
    .breadcrumb-nav {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-primary);
        padding: var(--space-3) 0;
    }

    .breadcrumb-list {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin: 0;
        padding: 0;
        list-style: none;
        font-family: var(--font-mono);
        font-size: var(--text-sm);
    }

    .breadcrumb-item {
        display: flex;
        align-items: center;
    }

    .breadcrumb-link {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        color: var(--text-secondary);
        text-decoration: none;
        transition: var(--transition-fast);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
    }

    .breadcrumb-link:hover {
        color: var(--accent-primary);
        background: rgba(0, 255, 136, 0.1);
        text-decoration: none;
    }

    .breadcrumb-separator {
        color: var(--text-muted);
        font-weight: var(--font-weight-bold);
    }

    .breadcrumb-text {
        color: var(--text-primary);
        font-weight: var(--font-weight-medium);
    }

    .breadcrumb-icon {
        font-size: 0.875rem;
    }

    /* Problem Header */
    .problem-header {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        border-bottom: 1px solid var(--border-primary);
        padding: var(--space-6) 0;
    }

    .problem-meta {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--space-6);
        flex-wrap: wrap;
    }

    .problem-title-section {
        flex: 1;
        min-width: 300px;
    }

    .problem-title {
        font-size: 2.5rem;
        font-weight: var(--font-weight-bold);
        font-family: var(--font-display);
        color: var(--text-primary);
        margin-bottom: var(--space-3);
        line-height: var(--line-height-tight);
    }

    .problem-badges {
        display: flex;
        gap: var(--space-2);
        align-items: center;
    }

    .problem-id-badge {
        background: var(--bg-tertiary);
        color: var(--text-muted);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
        font-family: var(--font-mono);
        font-size: var(--text-xs);
        font-weight: var(--font-weight-medium);
        border: 1px solid var(--border-primary);
    }

    .problem-stats {
        display: flex;
        gap: var(--space-4);
        align-items: center;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-1);
        text-align: center;
    }

    .stat-icon {
        font-size: 1.25rem;
        opacity: 0.8;
    }

    .stat-value {
        font-family: var(--font-mono);
        font-weight: var(--font-weight-bold);
        font-size: var(--text-lg);
        color: var(--accent-primary);
    }

    .stat-label {
        font-size: var(--text-xs);
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Split Pane Layout */
    .problem-workspace {
        flex: 1;
        padding: 0;
    }

    .split-pane-container {
        display: flex;
        height: calc(100vh - 200px);
        min-height: 600px;
    }

    .problem-pane {
        flex: 1;
        min-width: 400px;
        background: var(--bg-primary);
        border-right: 1px solid var(--border-primary);
        overflow-y: auto;
    }

    .editor-pane {
        flex: 1;
        min-width: 400px;
        background: var(--bg-secondary);
        display: flex;
        flex-direction: column;
    }

    .pane-content {
        padding: var(--space-6);
        height: 100%;
    }

    /* Resize Handle */
    .resize-handle {
        width: 4px;
        background: var(--border-primary);
        cursor: col-resize;
        position: relative;
        transition: var(--transition-fast);
    }

    .resize-handle:hover {
        background: var(--accent-primary);
    }

    .resize-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 2px;
        height: 20px;
        background: var(--text-muted);
        border-radius: 1px;
    }

    /* Problem Sections */
    .problem-section {
        margin-bottom: var(--space-8);
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--text-primary);
        margin-bottom: var(--space-4);
        font-family: var(--font-display);
    }

    .section-icon {
        font-size: 1.125rem;
        opacity: 0.8;
    }

    .problem-description {
        color: var(--text-secondary);
        line-height: var(--line-height-relaxed);
        font-size: var(--text-base);
        white-space: pre-wrap;
    }

    /* Examples */
    .example-container {
        display: grid;
        gap: var(--space-4);
    }

    .example-item {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        padding: var(--space-4);
    }

    .example-label {
        font-size: var(--text-sm);
        font-weight: var(--font-weight-medium);
        color: var(--accent-primary);
        margin-bottom: var(--space-2);
        font-family: var(--font-mono);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .code-block {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-secondary);
        border-radius: var(--radius-sm);
        padding: var(--space-3);
        margin: 0;
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        color: var(--text-primary);
        overflow-x: auto;
        white-space: pre;
    }

    /* Function Signatures */
    .signatures-container {
        display: grid;
        gap: var(--space-3);
    }

    .signature-item {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .signature-header {
        background: var(--bg-tertiary);
        padding: var(--space-2) var(--space-3);
        border-bottom: 1px solid var(--border-primary);
    }

    .language-tag {
        font-family: var(--font-mono);
        font-size: var(--text-xs);
        font-weight: var(--font-weight-medium);
        color: var(--accent-primary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    /* Submissions Preview */
    .submissions-preview {
        display: grid;
        gap: var(--space-2);
    }

    .submission-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-sm);
        padding: var(--space-3);
    }

    .submission-status {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .status-badge {
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
        font-family: var(--font-mono);
        font-size: var(--text-xs);
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-pass {
        background: var(--status-success-bg);
        color: var(--status-success);
        border: 1px solid var(--status-success-border);
    }

    .status-fail {
        background: var(--status-warning-bg);
        color: var(--status-warning);
        border: 1px solid var(--status-warning-border);
    }

    .status-error {
        background: var(--status-error-bg);
        color: var(--status-error);
        border: 1px solid var(--status-error-border);
    }

    .submission-language {
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        color: var(--text-secondary);
    }

    .submission-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: var(--space-1);
        font-size: var(--text-xs);
        color: var(--text-muted);
    }

    .submissions-link {
        text-align: center;
        margin-top: var(--space-2);
    }

    /* Editor Components */
    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4);
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-primary);
    }

    .editor-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-family: var(--font-mono);
        font-weight: var(--font-weight-medium);
        color: var(--text-primary);
    }

    .editor-icon {
        color: var(--accent-primary);
        font-size: 1.125rem;
    }

    .language-selector {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        color: var(--text-primary);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-sm);
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        cursor: pointer;
        transition: var(--transition-fast);
    }

    .language-selector:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 10px var(--accent-glow);
        outline: none;
    }

    .editor-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-tertiary);
    }

    .editor-wrapper {
        flex: 1;
        position: relative;
        display: flex;
        background: var(--bg-tertiary);
    }

    /* Line Numbers */
    .line-numbers {
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-primary);
        padding: var(--space-4) var(--space-2);
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        line-height: 1.5;
        color: var(--text-muted);
        user-select: none;
        min-width: 50px;
        text-align: right;
    }

    .line-number {
        height: 1.5em;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        transition: var(--transition-fast);
    }

    .line-number:hover {
        color: var(--accent-primary);
    }

    /* Code Editor Container */
    .code-editor-container {
        flex: 1;
        position: relative;
        overflow: hidden;
    }

    /* Syntax Highlighting Overlay */
    .syntax-highlight {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        margin: 0;
        padding: var(--space-4);
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        line-height: 1.5;
        color: transparent;
        background: transparent;
        border: none;
        outline: none;
        pointer-events: none;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow: hidden;
        tab-size: 4;
    }

    .syntax-highlight code {
        color: var(--text-primary);
    }

    /* Code Editor Textarea */
    .code-editor {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        border: none;
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        line-height: 1.5;
        padding: var(--space-4);
        resize: none;
        outline: none;
        tab-size: 4;
        caret-color: var(--accent-primary);
    }

    .code-editor::placeholder {
        color: var(--text-muted);
        font-style: italic;
    }

    .code-editor::selection {
        background: rgba(0, 255, 136, 0.2);
    }

    /* Syntax Highlighting Colors */
    .syntax-keyword {
        color: #ff6b9d;
        font-weight: var(--font-weight-medium);
    }

    .syntax-string {
        color: #a8e6cf;
    }

    .syntax-comment {
        color: var(--text-muted);
        font-style: italic;
    }

    .syntax-number {
        color: #ffd93d;
    }

    .syntax-function {
        color: #74c0fc;
    }

    .syntax-operator {
        color: var(--accent-primary);
    }

    .syntax-bracket {
        color: #ff8cc8;
    }

    .syntax-variable {
        color: var(--text-primary);
    }

    .editor-footer {
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-primary);
        padding: var(--space-4);
    }

    .editor-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-3);
    }

    /* Result Container */
    .result-container {
        margin-top: var(--space-4);
        border-top: 1px solid var(--border-primary);
        padding-top: var(--space-4);
    }

    .result-card {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        padding: 0;
        overflow: hidden;
        position: relative;
        transform: translateY(20px);
        opacity: 0;
        transition: var(--transition-normal);
    }

    .result-card.result-entering {
        animation: result-slide-in 0.3s ease-out forwards;
    }

    .result-card.result-visible {
        transform: translateY(0);
        opacity: 1;
    }

    .result-card.result-auto-hide {
        opacity: 0.6;
        transform: scale(0.98);
    }

    /* Result Header */
    .result-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-4);
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-primary);
    }

    .result-icon-container {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
    }

    .result-icon {
        font-size: 1.5rem;
        position: absolute;
        transition: var(--transition-normal);
    }

    .result-icon.primary {
        opacity: 1;
        transform: scale(1);
    }

    .result-icon.secondary {
        opacity: 0;
        transform: scale(0.8);
    }

    .result-title-section {
        flex: 1;
        margin-left: var(--space-3);
    }

    .result-title {
        font-family: var(--font-display);
        font-weight: var(--font-weight-bold);
        font-size: var(--text-lg);
        margin: 0 0 var(--space-1) 0;
        line-height: var(--line-height-tight);
    }

    .result-subtitle {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin: 0;
        font-family: var(--font-mono);
    }

    .result-timestamp {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        font-size: var(--text-xs);
        color: var(--text-muted);
        font-family: var(--font-mono);
    }

    /* Result Body */
    .result-body {
        padding: var(--space-4);
    }

    .result-message {
        margin-bottom: var(--space-4);
    }

    .message-content {
        color: var(--text-secondary);
        line-height: var(--line-height-relaxed);
        font-size: var(--text-base);
    }

    .error-message {
        background: var(--bg-primary);
        border: 1px solid var(--border-secondary);
        border-radius: var(--radius-sm);
        padding: var(--space-3);
        margin: var(--space-2) 0;
        font-family: var(--font-mono);
        font-size: var(--text-sm);
        color: var(--status-error);
        overflow-x: auto;
    }

    /* Performance Metrics */
    .result-metrics {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-sm);
        padding: var(--space-4);
        margin-top: var(--space-4);
    }

    .metrics-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-sm);
        font-weight: var(--font-weight-medium);
        color: var(--text-primary);
        margin: 0 0 var(--space-3) 0;
        font-family: var(--font-mono);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .metrics-icon {
        opacity: 0.8;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-3);
    }

    .metric-item {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2);
        background: var(--bg-tertiary);
        border: 1px solid var(--border-secondary);
        border-radius: var(--radius-sm);
        transition: var(--transition-fast);
    }

    .metric-item:hover {
        border-color: var(--accent-primary);
        box-shadow: 0 0 10px var(--accent-glow);
    }

    .metric-icon {
        font-size: 1.125rem;
        opacity: 0.8;
    }

    .metric-content {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .metric-label {
        font-size: var(--text-xs);
        color: var(--text-muted);
        font-family: var(--font-mono);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .metric-value {
        font-size: var(--text-sm);
        font-weight: var(--font-weight-semibold);
        font-family: var(--font-mono);
    }

    /* Result Footer */
    .result-footer {
        background: var(--bg-primary);
        border-top: 1px solid var(--border-primary);
        padding: var(--space-3) var(--space-4);
    }

    .result-actions {
        display: flex;
        gap: var(--space-2);
        justify-content: flex-end;
    }

    .btn-result-action {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        background: transparent;
        border: 1px solid var(--border-primary);
        color: var(--text-secondary);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-family: var(--font-mono);
        cursor: pointer;
        transition: var(--transition-fast);
    }

    .btn-result-action:hover {
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        background: rgba(0, 255, 136, 0.1);
    }

    .action-icon {
        font-size: 0.875rem;
    }

    /* Result State Styling */
    .result-success {
        border-color: var(--status-success-border);
    }

    .result-success .result-title {
        color: var(--status-success);
    }

    .result-success .result-header {
        background: var(--status-success-bg);
    }

    .result-fail {
        border-color: var(--status-warning-border);
    }

    .result-fail .result-title {
        color: var(--status-warning);
    }

    .result-fail .result-header {
        background: var(--status-warning-bg);
    }

    .result-error,
    .result-timeout {
        border-color: var(--status-error-border);
    }

    .result-error .result-title,
    .result-timeout .result-title {
        color: var(--status-error);
    }

    .result-error .result-header,
    .result-timeout .result-header {
        background: var(--status-error-bg);
    }

    /* Animations */
    @keyframes result-slide-in {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes success-pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }

    @keyframes fail-shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-5px);
        }

        75% {
            transform: translateX(5px);
        }
    }

    @keyframes error-flash {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    @keyframes timeout-pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.6;
        }
    }

    @keyframes celebration-fall {
        to {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
        }
    }

    /* Editor Error State */
    .editor-error-state {
        border-color: var(--status-error) !important;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.3) !important;
    }

    /* Details Expansion */
    .result-card.details-expanded .result-metrics {
        max-height: none;
    }

    .result-card.details-expanded .metrics-grid {
        grid-template-columns: 1fr;
    }

    .result-card.details-expanded .metric-item {
        flex-direction: column;
        align-items: flex-start;
        text-align: left;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .split-pane-container {
            flex-direction: column;
            height: auto;
        }

        .problem-pane,
        .editor-pane {
            min-width: 100%;
            flex: none;
        }

        .problem-pane {
            border-right: none;
            border-bottom: 1px solid var(--border-primary);
        }

        .resize-handle {
            display: none;
        }

        .problem-meta {
            flex-direction: column;
            gap: var(--space-4);
        }

        .problem-stats {
            justify-content: center;
        }
    }

    @media (max-width: 768px) {
        .problem-title {
            font-size: 2rem;
        }

        .pane-content {
            padding: var(--space-4);
        }

        .problem-badges {
            flex-wrap: wrap;
        }

        .problem-stats {
            gap: var(--space-3);
        }

        .editor-actions {
            flex-direction: column;
            gap: var(--space-2);
        }

        .btn-cyber-primary,
        .btn-cyber-secondary {
            width: 100%;
            justify-content: center;
        }

        /* Result display mobile optimizations */
        .result-header {
            flex-direction: column;
            gap: var(--space-3);
            align-items: flex-start;
        }

        .result-title-section {
            margin-left: 0;
            text-align: center;
            width: 100%;
        }

        .result-timestamp {
            align-self: flex-end;
        }

        .metrics-grid {
            grid-template-columns: 1fr;
        }

        .result-actions {
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-result-action {
            flex: 1;
            justify-content: center;
            min-width: 100px;
        }
    }

    @media (max-width: 480px) {
        .breadcrumb-list {
            font-size: var(--text-xs);
            gap: var(--space-1);
        }

        .problem-title {
            font-size: 1.75rem;
        }

        .example-container {
            gap: var(--space-3);
        }

        .submission-item {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--space-2);
        }

        .submission-meta {
            align-items: flex-start;
        }

        /* Mobile editor optimizations */
        .line-numbers {
            min-width: 40px;
            padding: var(--space-3) var(--space-1);
            font-size: var(--text-xs);
        }

        .code-editor,
        .syntax-highlight {
            font-size: 16px;
            /* Prevent zoom on iOS */
            padding: var(--space-3);
        }

        .editor-header {
            padding: var(--space-3);
            flex-direction: column;
            gap: var(--space-2);
            align-items: stretch;
        }

        .language-selector {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Function templates for different languages
    const functionTemplates = {
        python: `def solution(nums, target):
    """
    Your solution here
    """
    pass`,
        javascript: `function solution(nums, target) {
    // Your solution here
    
}`,
        java: `public int[] solution(int[] nums, int target) {
    // Your solution here
    
}`,
        cpp: `vector<int> solution(vector<int>& nums, int target) {
    // Your solution here
    
}`
    };

    // Problem signatures from backend (if available)
    const problemSignatures = {
        {% for language, signature in problem.function_signatures.items() %}
        '{{ language }}': `{{ signature }}`{{ "," if not loop.last else "" }}
        {% endfor %}
    };

    // Initialize problem detail page
    document.addEventListener('DOMContentLoaded', function () {
        initializeEditor();
        initializeResizeHandle();
        initializeKeyboardShortcuts();
    });

    function initializeEditor() {
        const languageSelect = document.getElementById('language-select');
        const codeEditor = document.getElementById('code-editor');
        const resetButton = document.getElementById('reset-code');
        const submitButton = document.getElementById('submit-code');
        const resultContainer = document.getElementById('result-container');

        // Set initial template
        updateCodeTemplate();

        // Language change handler
        languageSelect.addEventListener('change', function () {
            updateCodeTemplate();
        });

        // Reset button handler
        resetButton.addEventListener('click', function () {
            if (confirm('Are you sure you want to reset your code?')) {
                updateCodeTemplate();
            }
        });

        // Submit button handler
        submitButton.addEventListener('click', function () {
            submitCode();
        });

        // Auto-resize editor and update syntax highlighting
        codeEditor.addEventListener('input', function () {
            updateSyntaxHighlighting();
            updateLineNumbers();
        });

        // Sync scroll between editor and syntax highlighting
        codeEditor.addEventListener('scroll', function () {
            const syntaxHighlight = document.getElementById('syntaxHighlight');
            syntaxHighlight.scrollTop = codeEditor.scrollTop;
            syntaxHighlight.scrollLeft = codeEditor.scrollLeft;
        });

        function updateCodeTemplate() {
            const language = languageSelect.value;
            // Use problem-specific signature if available, otherwise use default template
            const template = problemSignatures[language] || functionTemplates[language] || '';
            codeEditor.value = template;
            updateSyntaxHighlighting();
            updateLineNumbers();
        }

        function updateLineNumbers() {
            const lineNumbers = document.getElementById('lineNumbers');
            const lines = codeEditor.value.split('\n');
            const lineCount = lines.length;

            // Generate line numbers
            let lineNumbersHTML = '';
            for (let i = 1; i <= lineCount; i++) {
                lineNumbersHTML += `<div class="line-number">${i}</div>`;
            }

            lineNumbers.innerHTML = lineNumbersHTML;
        }

        function updateSyntaxHighlighting() {
            const syntaxHighlight = document.getElementById('syntaxHighlight');
            const code = codeEditor.value;
            const language = languageSelect.value;

            // Apply syntax highlighting based on language
            const highlightedCode = applySyntaxHighlighting(code, language);
            syntaxHighlight.querySelector('code').innerHTML = highlightedCode;
        }

        function applySyntaxHighlighting(code, language) {
            if (!code) return '';

            // Escape HTML
            code = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // Language-specific highlighting patterns
            const patterns = getSyntaxPatterns(language);

            // Apply highlighting patterns
            for (const pattern of patterns) {
                code = code.replace(pattern.regex, pattern.replacement);
            }

            return code;
        }

        function getSyntaxPatterns(language) {
            const commonPatterns = [
                // Comments
                { regex: /(\/\/.*$)/gm, replacement: '<span class="syntax-comment">$1</span>' },
                { regex: /(\/\*[\s\S]*?\*\/)/g, replacement: '<span class="syntax-comment">$1</span>' },
                { regex: /(#.*$)/gm, replacement: '<span class="syntax-comment">$1</span>' },

                // Strings
                { regex: /("(?:[^"\\]|\\.)*")/g, replacement: '<span class="syntax-string">$1</span>' },
                { regex: /('(?:[^'\\]|\\.)*')/g, replacement: '<span class="syntax-string">$1</span>' },

                // Numbers
                { regex: /\b(\d+\.?\d*)\b/g, replacement: '<span class="syntax-number">$1</span>' },

                // Operators
                { regex: /([+\-*/%=<>!&|^~])/g, replacement: '<span class="syntax-operator">$1</span>' },

                // Brackets
                { regex: /([(){}[\]])/g, replacement: '<span class="syntax-bracket">$1</span>' }
            ];

            const languagePatterns = {
                python: [
                    { regex: /\b(def|class|if|elif|else|for|while|try|except|finally|with|import|from|as|return|yield|break|continue|pass|lambda|and|or|not|in|is|True|False|None)\b/g, replacement: '<span class="syntax-keyword">$1</span>' },
                    { regex: /\b([a-zA-Z_][a-zA-Z0-9_]*)\s*(?=\()/g, replacement: '<span class="syntax-function">$1</span>' }
                ],
                javascript: [
                    { regex: /\b(function|var|let|const|if|else|for|while|do|switch|case|default|try|catch|finally|throw|return|break|continue|new|this|typeof|instanceof|true|false|null|undefined)\b/g, replacement: '<span class="syntax-keyword">$1</span>' },
                    { regex: /\b([a-zA-Z_$][a-zA-Z0-9_$]*)\s*(?=\()/g, replacement: '<span class="syntax-function">$1</span>' }
                ],
                java: [
                    { regex: /\b(public|private|protected|static|final|abstract|class|interface|extends|implements|if|else|for|while|do|switch|case|default|try|catch|finally|throw|throws|return|break|continue|new|this|super|true|false|null|void|int|double|float|long|short|byte|char|boolean|String)\b/g, replacement: '<span class="syntax-keyword">$1</span>' },
                    { regex: /\b([a-zA-Z_][a-zA-Z0-9_]*)\s*(?=\()/g, replacement: '<span class="syntax-function">$1</span>' }
                ],
                cpp: [
                    { regex: /\b(int|double|float|char|bool|void|auto|const|static|extern|inline|virtual|public|private|protected|class|struct|namespace|using|if|else|for|while|do|switch|case|default|try|catch|throw|return|break|continue|new|delete|this|true|false|nullptr)\b/g, replacement: '<span class="syntax-keyword">$1</span>' },
                    { regex: /\b([a-zA-Z_][a-zA-Z0-9_]*)\s*(?=\()/g, replacement: '<span class="syntax-function">$1</span>' }
                ]
            };

            return [...commonPatterns, ...(languagePatterns[language] || [])];
        }

        function submitCode() {
            const code = codeEditor.value.trim();
            const language = languageSelect.value;
            const problemId = document.getElementById('problem-id').value;

            if (!code || code === (problemSignatures[language] || functionTemplates[language] || '')) {
                showNotification('Please write your solution before submitting.', 'warning');
                return;
            }

            // Update submit button state
            const originalContent = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = `
            <span class="btn-icon animate-spin">‚ü≥</span>
            <span>Executing...</span>
        `;

            // Prepare form data
            const formData = new FormData();
            formData.append('problem_id', problemId);
            formData.append('code', code);
            formData.append('language', language);

            fetch('/submit', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    showResult(
                        data.result.toLowerCase(),
                        data.message,
                        data.execution_time,
                        data.memory_used,
                        data.test_cases_passed,
                        data.total_test_cases
                    );
                })
                .catch(error => {
                    showResult('error', 'Submission failed. Please check your connection and try again.', null, null, null, null);
                    console.error('Submission error:', error);
                })
                .finally(() => {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalContent;
                });
        }

        function showResult(result, message, executionTime, memoryUsed, testCasesPassed, totalTestCases) {
            // Store result in session history
            storeResultInHistory(result, message, executionTime, memoryUsed);

            // Determine result styling and content
            const resultData = getResultDisplayData(result);

            // Create performance metrics
            const performanceMetrics = createPerformanceMetrics(executionTime, memoryUsed, testCasesPassed, totalTestCases);

            // Create result card with animation
            const resultCard = createResultCard(resultData, message, performanceMetrics);

            // Display result with animation
            displayResultWithAnimation(resultCard, result);

            // Add result-specific behaviors
            addResultBehaviors(result);
        }

        function getResultDisplayData(result) {
            const resultTypes = {
                'pass': {
                    icon: 'üéâ',
                    iconAlt: '‚úÖ',
                    title: 'Success!',
                    subtitle: 'All test cases passed',
                    class: 'result-success',
                    color: 'var(--status-success)',
                    bgColor: 'var(--status-success-bg)',
                    borderColor: 'var(--status-success-border)',
                    animation: 'success-pulse'
                },
                'fail': {
                    icon: '‚ùå',
                    iconAlt: '‚ö†Ô∏è',
                    title: 'Test Failed',
                    subtitle: 'Some test cases failed',
                    class: 'result-fail',
                    color: 'var(--status-warning)',
                    bgColor: 'var(--status-warning-bg)',
                    borderColor: 'var(--status-warning-border)',
                    animation: 'fail-shake'
                },
                'error': {
                    icon: 'üö®',
                    iconAlt: '‚ùå',
                    title: 'Runtime Error',
                    subtitle: 'Code execution failed',
                    class: 'result-error',
                    color: 'var(--status-error)',
                    bgColor: 'var(--status-error-bg)',
                    borderColor: 'var(--status-error-border)',
                    animation: 'error-flash'
                },
                'timeout': {
                    icon: '‚è±Ô∏è',
                    iconAlt: '‚ö†Ô∏è',
                    title: 'Time Limit Exceeded',
                    subtitle: 'Code took too long to execute',
                    class: 'result-timeout',
                    color: 'var(--status-warning)',
                    bgColor: 'var(--status-warning-bg)',
                    borderColor: 'var(--status-warning-border)',
                    animation: 'timeout-pulse'
                }
            };

            return resultTypes[result] || resultTypes['error'];
        }

        function createPerformanceMetrics(executionTime, memoryUsed, testCasesPassed, totalTestCases) {
            const metrics = [];

            // Execution time
            if (executionTime !== null && executionTime !== undefined) {
                const timeColor = executionTime < 1 ? 'var(--status-success)' :
                    executionTime < 3 ? 'var(--status-warning)' : 'var(--status-error)';
                metrics.push({
                    icon: '‚ö°',
                    label: 'Execution Time',
                    value: `${executionTime.toFixed(3)}s`,
                    color: timeColor
                });
            }

            // Memory usage (simulated for now)
            if (memoryUsed !== null && memoryUsed !== undefined) {
                const memoryMB = (memoryUsed / 1024 / 1024).toFixed(2);
                const memoryColor = memoryUsed < 50 * 1024 * 1024 ? 'var(--status-success)' :
                    memoryUsed < 100 * 1024 * 1024 ? 'var(--status-warning)' : 'var(--status-error)';
                metrics.push({
                    icon: 'üíæ',
                    label: 'Memory Used',
                    value: `${memoryMB} MB`,
                    color: memoryColor
                });
            }

            // Test cases passed
            if (testCasesPassed !== null && testCasesPassed !== undefined && totalTestCases) {
                const passRate = (testCasesPassed / totalTestCases * 100).toFixed(0);
                const testColor = testCasesPassed === totalTestCases ? 'var(--status-success)' : 'var(--status-error)';
                metrics.push({
                    icon: 'üß™',
                    label: 'Test Cases',
                    value: `${testCasesPassed}/${totalTestCases} (${passRate}%)`,
                    color: testColor
                });
            }

            return metrics;
        }

        function createResultCard(resultData, message, performanceMetrics) {
            const metricsHTML = performanceMetrics.map(metric => `
            <div class="metric-item">
                <span class="metric-icon">${metric.icon}</span>
                <div class="metric-content">
                    <span class="metric-label">${metric.label}</span>
                    <span class="metric-value" style="color: ${metric.color}">${metric.value}</span>
                </div>
            </div>
        `).join('');

            const timestamp = new Date().toLocaleTimeString();

            return `
            <div class="result-card ${resultData.class}" data-animation="${resultData.animation}">
                <div class="result-header">
                    <div class="result-icon-container">
                        <span class="result-icon primary">${resultData.icon}</span>
                        <span class="result-icon secondary">${resultData.iconAlt}</span>
                    </div>
                    <div class="result-title-section">
                        <h3 class="result-title">${resultData.title}</h3>
                        <p class="result-subtitle">${resultData.subtitle}</p>
                    </div>
                    <div class="result-timestamp">
                        <span class="timestamp-icon">üïê</span>
                        <span class="timestamp-text">${timestamp}</span>
                    </div>
                </div>
                
                <div class="result-body">
                    <div class="result-message">
                        <div class="message-content">${formatResultMessage(message)}</div>
                    </div>
                    
                    ${performanceMetrics.length > 0 ? `
                        <div class="result-metrics">
                            <h4 class="metrics-title">
                                <span class="metrics-icon">üìä</span>
                                Performance Metrics
                            </h4>
                            <div class="metrics-grid">
                                ${metricsHTML}
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="result-footer">
                    <div class="result-actions">
                        <button class="btn-result-action" onclick="copyResultToClipboard()">
                            <span class="action-icon">üìã</span>
                            <span>Copy Result</span>
                        </button>
                        <button class="btn-result-action" onclick="toggleResultDetails()">
                            <span class="action-icon">üîç</span>
                            <span>Details</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
        }

        function formatResultMessage(message) {
            if (!message) return 'No additional information available.';

            // Format error messages with syntax highlighting
            if (message.includes('Error:') || message.includes('Exception:')) {
                return `<pre class="error-message"><code>${escapeHtml(message)}</code></pre>`;
            }

            // Format test case failures
            if (message.includes('Expected:') || message.includes('Actual:')) {
                return message.replace(/(Expected:|Actual:)/g, '<strong>$1</strong>');
            }

            return message;
        }

        function displayResultWithAnimation(resultCard, result) {
            // Clear previous results
            resultContainer.innerHTML = '';

            // Create and insert new result
            resultContainer.innerHTML = resultCard;
            resultContainer.style.display = 'block';

            // Trigger entrance animation
            const card = resultContainer.querySelector('.result-card');
            card.classList.add('result-entering');

            // Scroll to result
            setTimeout(() => {
                resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);

            // Remove entrance animation class
            setTimeout(() => {
                card.classList.remove('result-entering');
                card.classList.add('result-visible');
            }, 300);

            // Trigger result-specific animation
            setTimeout(() => {
                const animation = card.dataset.animation;
                if (animation) {
                    card.classList.add(animation);
                    setTimeout(() => card.classList.remove(animation), 1000);
                }
            }, 500);
        }

        function addResultBehaviors(result) {
            // Auto-hide success results after 10 seconds
            if (result === 'pass') {
                setTimeout(() => {
                    const card = resultContainer.querySelector('.result-card');
                    if (card) {
                        card.classList.add('result-auto-hide');
                    }
                }, 10000);
            }

            // Add celebration effect for success
            if (result === 'pass') {
                createCelebrationEffect();
            }

            // Add error highlighting for failures
            if (result === 'fail' || result === 'error') {
                highlightErrorInCode();
            }
        }

        function storeResultInHistory(result, message, executionTime, memoryUsed) {
            const resultHistory = JSON.parse(sessionStorage.getItem('resultHistory') || '[]');

            const resultEntry = {
                timestamp: new Date().toISOString(),
                result: result,
                message: message,
                executionTime: executionTime,
                memoryUsed: memoryUsed,
                language: document.getElementById('language-select').value,
                problemId: document.getElementById('problem-id').value
            };

            resultHistory.unshift(resultEntry);

            // Keep only last 10 results
            if (resultHistory.length > 10) {
                resultHistory.splice(10);
            }

            sessionStorage.setItem('resultHistory', JSON.stringify(resultHistory));
        }

        function createCelebrationEffect() {
            // Create confetti-like effect
            const colors = ['var(--accent-primary)', 'var(--status-success)', '#ffd93d', '#ff8cc8'];

            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'celebration-particle';
                    particle.style.cssText = `
                    position: fixed;
                    width: 8px;
                    height: 8px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1000;
                    left: ${Math.random() * window.innerWidth}px;
                    top: -10px;
                    animation: celebration-fall ${2 + Math.random() * 3}s linear forwards;
                `;

                    document.body.appendChild(particle);

                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.parentNode.removeChild(particle);
                        }
                    }, 5000);
                }, i * 100);
            }
        }

        function highlightErrorInCode() {
            // Add subtle error highlighting to the editor
            const codeEditor = document.getElementById('code-editor');
            codeEditor.classList.add('editor-error-state');

            setTimeout(() => {
                codeEditor.classList.remove('editor-error-state');
            }, 3000);
        }

        function copyResultToClipboard() {
            const resultCard = resultContainer.querySelector('.result-card');
            const title = resultCard.querySelector('.result-title').textContent;
            const message = resultCard.querySelector('.message-content').textContent;
            const metrics = Array.from(resultCard.querySelectorAll('.metric-item')).map(item => {
                const label = item.querySelector('.metric-label').textContent;
                const value = item.querySelector('.metric-value').textContent;
                return `${label}: ${value}`;
            }).join('\n');

            const resultText = `${title}\n${message}\n\n${metrics}`;

            navigator.clipboard.writeText(resultText).then(() => {
                showNotification('Result copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy result', 'error');
            });
        }

        function toggleResultDetails() {
            const resultCard = resultContainer.querySelector('.result-card');
            resultCard.classList.toggle('details-expanded');

            const button = resultCard.querySelector('.btn-result-action:last-child span:last-child');
            button.textContent = resultCard.classList.contains('details-expanded') ? 'Hide' : 'Details';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    } // End of initializeEditor function

    function initializeResizeHandle() {
        const resizeHandle = document.getElementById('resizeHandle');
        const problemPane = document.querySelector('.problem-pane');
        const editorPane = document.querySelector('.editor-pane');
        const container = document.querySelector('.split-pane-container');

        if (!resizeHandle || window.innerWidth <= 1024) {
            return; // Skip on mobile
        }

        let isResizing = false;

        resizeHandle.addEventListener('mousedown', function (e) {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', function (e) {
            if (!isResizing) return;

            const containerRect = container.getBoundingClientRect();
            const mouseX = e.clientX - containerRect.left;
            const containerWidth = containerRect.width;

            // Calculate percentages (min 30%, max 70%)
            let leftPercent = (mouseX / containerWidth) * 100;
            leftPercent = Math.max(30, Math.min(70, leftPercent));

            problemPane.style.flex = `0 0 ${leftPercent}%`;
            editorPane.style.flex = `0 0 ${100 - leftPercent}%`;
        });

        document.addEventListener('mouseup', function () {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });
    }

    function initializeKeyboardShortcuts() {
        const codeEditor = document.getElementById('code-editor');

        document.addEventListener('keydown', function (e) {
            // Ctrl/Cmd + Enter to submit
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('submit-code').click();
            }

            // Ctrl/Cmd + R to reset (prevent browser refresh)
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                document.getElementById('reset-code').click();
            }

            // Enhanced tab handling in textarea
            if (e.target === codeEditor) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = codeEditor.selectionStart;
                    const end = codeEditor.selectionEnd;

                    if (e.shiftKey) {
                        // Shift+Tab: Remove indentation
                        const lines = codeEditor.value.split('\n');
                        const startLine = codeEditor.value.substring(0, start).split('\n').length - 1;
                        const endLine = codeEditor.value.substring(0, end).split('\n').length - 1;

                        for (let i = startLine; i <= endLine; i++) {
                            if (lines[i].startsWith('    ')) {
                                lines[i] = lines[i].substring(4);
                            } else if (lines[i].startsWith('\t')) {
                                lines[i] = lines[i].substring(1);
                            }
                        }

                        codeEditor.value = lines.join('\n');
                    } else {
                        // Tab: Add indentation
                        if (start === end) {
                            // Single cursor: insert tab
                            codeEditor.value = codeEditor.value.substring(0, start) +
                                '    ' +
                                codeEditor.value.substring(end);
                            codeEditor.selectionStart = codeEditor.selectionEnd = start + 4;
                        } else {
                            // Selection: indent all lines
                            const lines = codeEditor.value.split('\n');
                            const startLine = codeEditor.value.substring(0, start).split('\n').length - 1;
                            const endLine = codeEditor.value.substring(0, end).split('\n').length - 1;

                            for (let i = startLine; i <= endLine; i++) {
                                lines[i] = '    ' + lines[i];
                            }

                            codeEditor.value = lines.join('\n');
                        }
                    } // End of else block for Tab handling

                    updateSyntaxHighlighting();
                    updateLineNumbers();
                } // End of if (e.key === 'Tab')

                // Auto-closing brackets
                else if (e.key === '(' || e.key === '[' || e.key === '{') {
                    const closingBrackets = { '(': ')', '[': ']', '{': '}' };
                    const start = codeEditor.selectionStart;
                    const end = codeEditor.selectionEnd;

                    if (start === end) {
                        e.preventDefault();
                        const closing = closingBrackets[e.key];
                        codeEditor.value = codeEditor.value.substring(0, start) +
                            e.key + closing +
                            codeEditor.value.substring(end);
                        codeEditor.selectionStart = codeEditor.selectionEnd = start + 1;

                        updateSyntaxHighlighting();
                    }
                }

                // Auto-closing quotes
                else if (e.key === '"' || e.key === "'") {
                    const start = codeEditor.selectionStart;
                    const end = codeEditor.selectionEnd;

                    if (start === end) {
                        const charBefore = codeEditor.value[start - 1];
                        const charAfter = codeEditor.value[start];

                        // Only auto-close if not already between quotes
                        if (charBefore !== e.key && charAfter !== e.key) {
                            e.preventDefault();
                            codeEditor.value = codeEditor.value.substring(0, start) +
                                e.key + e.key +
                                codeEditor.value.substring(end);
                            codeEditor.selectionStart = codeEditor.selectionEnd = start + 1;

                            updateSyntaxHighlighting();
                        }
                    }
                }

                // Enter key: auto-indentation
                else if (e.key === 'Enter') {
                    const start = codeEditor.selectionStart;
                    const lines = codeEditor.value.substring(0, start).split('\n');
                    const currentLine = lines[lines.length - 1];
                    const indent = currentLine.match(/^(\s*)/)[1];

                    // Add extra indent after opening brackets
                    const extraIndent = /[({[]$/.test(currentLine.trim()) ? '    ' : '';

                    setTimeout(() => {
                        const newStart = codeEditor.selectionStart;
                        codeEditor.value = codeEditor.value.substring(0, newStart) +
                            indent + extraIndent +
                            codeEditor.value.substring(newStart);
                        codeEditor.selectionStart = codeEditor.selectionEnd = newStart + indent.length + extraIndent.length;

                        updateSyntaxHighlighting();
                        updateLineNumbers();
                    }, 0);
                }
            } // End of if (e.target === codeEditor)
        });
    }

    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">
                ${type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}
            </span>
            <span class="notification-message">${message}</span>
        </div>
    `;

        // Add to page
        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => notification.classList.add('show'), 100);

        // Remove after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
    }

    // Add notification styles
    const notificationStyles = `
<style>
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--space-3) var(--space-4);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    transform: translateX(100%);
    transition: var(--transition-normal);
    max-width: 300px;
}

.notification.show {
    transform: translateX(0);
}

.notification-content {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.notification-message {
    color: var(--text-primary);
    font-size: var(--text-sm);
}

.notification-warning {
    border-color: var(--status-warning-border);
    background: var(--status-warning-bg);
}

.notification-success {
    border-color: var(--status-success-border);
    background: var(--status-success-bg);
}

.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
`;

    document.head.insertAdjacentHTML('beforeend', notificationStyles);
</script>
{% endblock %}