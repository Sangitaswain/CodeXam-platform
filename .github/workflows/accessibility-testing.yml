name: Accessibility Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run accessibility tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  accessibility-test:
    runs-on: ubuntu-latest
    
    services:
      # Start a local server for testing
      web:
        image: python:3.9
        ports:
          - 5000:5000
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          chromium-chromedriver \
          xvfb
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-accessibility.txt
        
    - name: Start application
      run: |
        python app.py &
        sleep 10  # Wait for server to start
        curl -f http://localhost:5000 || exit 1
      env:
        FLASK_ENV: testing
        
    - name: Run accessibility tests
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 &
        python run_accessibility_tests.py --headless --output json
      env:
        CHROMEDRIVER_PATH: /usr/bin/chromedriver
        
    - name: Upload accessibility report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: accessibility-report
        path: |
          accessibility_report.html
          accessibility_report.json
          accessibility_report.txt
        retention-days: 30
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            const report = JSON.parse(fs.readFileSync('accessibility_report.json', 'utf8'));
            const summary = report.summary;
            
            const status = summary.wcag_compliant ? '‚úÖ PASS' : '‚ùå FAIL';
            const emoji = summary.wcag_compliant ? 'üéâ' : '‚ö†Ô∏è';
            
            const comment = `## ${emoji} Accessibility Test Results
            
**WCAG 2.1 AA Compliance: ${status}**

### Summary
- üêõ Total Issues: ${summary.total_issues}
- üî¥ Critical: ${summary.critical_issues}
- üü° Major: ${summary.major_issues}  
- üîµ Minor: ${summary.minor_issues}

### Details
${summary.critical_issues > 0 ? '‚ùå Critical accessibility barriers found that must be fixed before merge.' : ''}
${summary.major_issues > 0 ? '‚ö†Ô∏è Major accessibility issues found that should be addressed.' : ''}
${summary.wcag_compliant ? '‚úÖ No critical or major accessibility issues found!' : ''}

[View detailed report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Could not read accessibility report:', error);
          }
          
    - name: Fail if critical issues found
      run: |
        if [ -f accessibility_report.json ]; then
          CRITICAL=$(python -c "import json; report=json.load(open('accessibility_report.json')); print(report['summary']['critical_issues'])")
          MAJOR=$(python -c "import json; report=json.load(open('accessibility_report.json')); print(report['summary']['major_issues'])")
          
          if [ "$CRITICAL" -gt 0 ] || [ "$MAJOR" -gt 0 ]; then
            echo "‚ùå Accessibility test failed: $CRITICAL critical, $MAJOR major issues"
            exit 1
          else
            echo "‚úÖ Accessibility test passed: No critical or major issues"
          fi
        else
          echo "‚ùå Accessibility report not found"
          exit 1
        fi

  lighthouse-audit:
    runs-on: ubuntu-latest
    needs: accessibility-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Lighthouse CI
      run: npm install -g @lhci/cli@0.12.x
      
    - name: Start application
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python app.py &
        sleep 10
      env:
        FLASK_ENV: testing
        
    - name: Run Lighthouse CI
      run: |
        lhci autorun --config=.lighthouserc.json || echo "Lighthouse CI completed with warnings"
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        
    - name: Upload Lighthouse report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: lighthouse-report
        path: .lighthouseci/
        retention-days: 30